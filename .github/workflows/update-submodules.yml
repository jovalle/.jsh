name: Update Submodules

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sundays at 00:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    name: Update Submodules
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update all submodules
        id: update
        run: |
          updates=""

          # Define submodules and their default branches
          declare -A submodules=(
            ["lib/p10k"]="master"
            ["lib/zsh-syntax-highlighting"]="master"
            ["lib/zsh-autosuggestions"]="master"
            ["lib/zsh-history-substring-search"]="master"
            ["lib/zsh-completions"]="master"
            ["lib/zsh-z"]="master"
          )

          for path in "${!submodules[@]}"; do
            branch="${submodules[$path]}"
            name=$(basename "$path")

            if [[ ! -d "$path" ]]; then
              echo "Skipping $name: directory not found"
              continue
            fi

            cd "$path"
            git fetch origin

            old=$(git rev-parse HEAD)
            git checkout "origin/${branch}"
            new=$(git rev-parse HEAD)

            if [[ "$old" != "$new" ]]; then
              short_old="${old:0:7}"
              short_new="${new:0:7}"
              updates="${updates}- **${name}**: \`${short_old}\` -> \`${short_new}\`\n"
              echo "Updated ${name}: ${short_old} -> ${short_new}"
            fi

            cd - > /dev/null
          done

          # Save updates for PR body
          echo "updates<<EOF" >> $GITHUB_OUTPUT
          echo -e "$updates" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [[ -n "$updates" ]]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for updates
        id: check
        run: echo "has_updates=${{ steps.update.outputs.has_updates }}" >> $GITHUB_OUTPUT

      - name: Create PR for updates
        if: steps.update.outputs.has_updates == 'true'
        run: |
          BRANCH="chore/update-submodules-$(date +%Y%m%d)"
          git checkout -b "$BRANCH"

          git add lib/
          git commit -m "chore(deps): update submodules"
          git push origin "$BRANCH"

          gh pr create \
            --title "chore(deps): update submodules" \
            --body "$(cat <<EOF
          ## Updated Submodules

          ${{ steps.update.outputs.updates }}

          ---
          *Auto-generated by update-submodules workflow*
          EOF
          )" \
            --base main \
            --head "$BRANCH"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
