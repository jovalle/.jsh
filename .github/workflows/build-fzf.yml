name: Build fzf Binaries

# Runs on push to main when fzf submodule changes.
# CI runs on PRs, so branch protection ensures CI passed before merge.

on:
  push:
    branches: [main]
    paths:
      - 'lib/fzf'
      - '.gitmodules'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build fzf
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache-dependency-path: lib/fzf/go.sum

      - name: Get fzf version
        id: version
        run: |
          cd lib/fzf
          VERSION=$(git describe --tags --always)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building fzf $VERSION"

      - name: Build binaries
        run: |
          cd lib/fzf

          # Build for all target platforms
          platforms=(
            "darwin/amd64"
            "darwin/arm64"
            "linux/amd64"
            "linux/arm64"
          )

          for platform in "${platforms[@]}"; do
            GOOS="${platform%/*}"
            GOARCH="${platform#*/}"
            output_dir="../../lib/bin/${GOOS}-${GOARCH}"
            output_name="fzf"

            echo "Building for $GOOS/$GOARCH..."
            mkdir -p "$output_dir"

            CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build \
              -ldflags="-s -w -X main.version=${{ steps.version.outputs.version }} -X main.revision=$(git rev-parse --short HEAD)" \
              -o "${output_dir}/${output_name}" \
              .

            echo "Built: ${output_dir}/${output_name}"
          done

      - name: Verify binaries
        run: |
          echo "Built binaries:"
          find lib/bin -name "fzf" -exec ls -lh {} \;
          echo ""
          echo "Version check (native binary):"
          lib/bin/linux-amd64/fzf --version

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit binaries
        run: |
          git add lib/bin/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update fzf binaries to ${{ steps.version.outputs.version }} [skip ci]

            Built for: darwin-amd64, darwin-arm64, linux-amd64, linux-arm64"
            git push
          fi
