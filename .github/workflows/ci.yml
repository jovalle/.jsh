# =============================================================================
# Jsh CI/CD Pipeline
# =============================================================================
#
# This workflow handles:
# - Linting (ShellCheck, yamllint, syntax checking, secret scanning)
# - Testing (BATS tests across OS/shell matrix)
#
# All operations use Makefile targets for local/CI parity.
# =============================================================================

name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - ".vscode/**"
      - "docs/**"
  pull_request:
    branches: [main]

env:
  # Disable colors in CI for cleaner logs
  CI: "true"

jobs:
  # ===========================================================================
  # Lint Job - Fast feedback on code quality
  # ===========================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install linting tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          pip install --user yamllint pre-commit

      - name: Run linters
        run: make ci-lint

  # ===========================================================================
  # Test Job - Matrix testing across OS and shell
  # ===========================================================================
  test:
    name: Test (${{ matrix.os }} / ${{ matrix.shell }})
    runs-on: ${{ matrix.os }}
    needs: lint

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        shell: [bash, zsh]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install bats-core
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update && sudo apt-get install -y bats
          else
            brew install bats-core
          fi
        shell: bash

      - name: Run tests
        run: make test
        shell: ${{ matrix.shell }} {0}

  # ===========================================================================
  # CI Complete Job - Aggregates results for branch protection
  # ===========================================================================
  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: always()

    steps:
      - name: Check results
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          TEST_RESULT: ${{ needs.test.result }}
        run: |
          echo "Lint: ${LINT_RESULT}"
          echo "Test: ${TEST_RESULT}"

          if [[ "${LINT_RESULT}" != "success" ]] || \
             [[ "${TEST_RESULT}" != "success" ]]; then
            echo "::error::One or more CI jobs failed"
            exit 1
          fi

          echo "::notice::All CI checks passed!"
