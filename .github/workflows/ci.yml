# =============================================================================
# Jsh CI/CD Pipeline
# =============================================================================
#
# This workflow handles:
# - Linting (ShellCheck, yamllint, syntax checking)
# - Testing (BATS tests across OS/shell matrix)
# - Docker image building and testing
# - Binary/plugin updates (scheduled or on-demand)
#
# All operations use Makefile targets for local/CI parity.
# =============================================================================

name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - ".vscode/**"
      - "docs/**"
  pull_request:
    branches: [main]
  schedule:
    # Weekly binary updates - Sundays at 00:00 UTC
    - cron: "0 0 * * 0"
  workflow_dispatch:
    inputs:
      update_binaries:
        description: "Force binary/plugin update"
        type: boolean
        default: false
      skip_tests:
        description: "Skip tests (for binary-only updates)"
        type: boolean
        default: false

env:
  # Disable colors in CI for cleaner logs
  CI: "true"

jobs:
  # ===========================================================================
  # Lint Job - Fast feedback on code quality
  # ===========================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install linting tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          pip install --user yamllint

      - name: Run linters
        run: make ci-lint

  # ===========================================================================
  # Test Job - Matrix testing across OS and shell
  # ===========================================================================
  test:
    name: Test (${{ matrix.os }} / ${{ matrix.shell }})
    runs-on: ${{ matrix.os }}
    if: ${{ !inputs.skip_tests }}
    needs: lint

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        shell: [bash, zsh]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install bats-core
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update && sudo apt-get install -y bats
          else
            brew install bats-core
          fi
        shell: bash

      - name: Run tests
        run: make test
        shell: ${{ matrix.shell }} {0}

  # ===========================================================================
  # Docker Job - Verify container builds and works
  # ===========================================================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: make docker-build

      - name: Test in Docker container
        run: make docker-test

  # ===========================================================================
  # Update Binaries Job - Download binaries on version changes or schedule
  # ===========================================================================
  update-binaries:
    name: Update Binaries
    runs-on: ubuntu-latest
    # Run on: schedule, manual trigger with update_binaries, or versions.json changes
    if: |
      github.event_name == 'schedule' ||
      inputs.update_binaries == true ||
      (github.event_name == 'push' && contains(join(github.event.commits.*.modified, ','), 'lib/bin/versions.json'))

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache binaries
        uses: actions/cache@v5
        with:
          path: |
            lib/bin/linux-*
            lib/bin/darwin-*
            lib/zsh-plugins
          key: binaries-${{ hashFiles('lib/bin/versions.json') }}

      - name: Read versions
        id: versions
        run: |
          # Read versions from our controlled versions.json file
          # These are NOT user-controlled inputs - they come from our repository
          V="lib/bin/versions.json"
          echo "fzf=$(jq -r '.fzf' $V)" >> $GITHUB_OUTPUT
          echo "jq_ver=$(jq -r '.jq' $V)" >> $GITHUB_OUTPUT
          echo "zsh_autosuggestions=$(jq -r '."zsh-autosuggestions"' $V)" >> $GITHUB_OUTPUT
          echo "zsh_syntax_highlighting=$(jq -r '."zsh-syntax-highlighting"' $V)" >> $GITHUB_OUTPUT
          echo "zsh_history_search=$(jq -r '."zsh-history-substring-search"' $V)" >> $GITHUB_OUTPUT

      - name: Create platform directories
        run: mkdir -p lib/bin/{linux-amd64,linux-arm64,darwin-amd64,darwin-arm64}

      - name: Download all binaries and plugins
        run: make ci-binaries

      - name: Verify linux-amd64 binaries
        run: |
          echo "=== Verifying binaries ==="
          ./lib/bin/linux-amd64/fzf --version
          ./lib/bin/linux-amd64/jq --version
          echo "=== Verification complete ==="

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --cached --name-only
          fi

      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true'
        env:
          # Use environment variables for version strings (safe pattern)
          FZF_VER: ${{ steps.versions.outputs.fzf }}
          JQ_VER: ${{ steps.versions.outputs.jq_ver }}
          ZSH_AUTO_VER: ${{ steps.versions.outputs.zsh_autosuggestions }}
          ZSH_SYNTAX_VER: ${{ steps.versions.outputs.zsh_syntax_highlighting }}
          ZSH_HISTORY_VER: ${{ steps.versions.outputs.zsh_history_search }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -m "chore(deps): update binaries and plugins

          Binaries:
          - fzf: ${FZF_VER}
          - jq: ${JQ_VER}

          Plugins:
          - zsh-autosuggestions: ${ZSH_AUTO_VER}
          - zsh-syntax-highlighting: ${ZSH_SYNTAX_VER}
          - zsh-history-substring-search: ${ZSH_HISTORY_VER}"

          git push

  # ===========================================================================
  # CI Complete Job - Aggregates results for branch protection
  # ===========================================================================
  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [lint, test, docker]
    if: always() && !inputs.skip_tests

    steps:
      - name: Check results
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          TEST_RESULT: ${{ needs.test.result }}
          DOCKER_RESULT: ${{ needs.docker.result }}
        run: |
          echo "Lint: ${LINT_RESULT}"
          echo "Test: ${TEST_RESULT}"
          echo "Docker: ${DOCKER_RESULT}"

          if [[ "${LINT_RESULT}" != "success" ]] || \
             [[ "${TEST_RESULT}" != "success" ]] || \
             [[ "${DOCKER_RESULT}" != "success" ]]; then
            echo "::error::One or more CI jobs failed"
            exit 1
          fi

          echo "::notice::All CI checks passed!"
