---
# yaml-language-server: $schema=https://taskfile.dev/schema.json

dotenv:
  - .env
  - "{{.ENV}}/.env."
  - "{{.HOME}}/.env"

includes:
  os: ".taskfiles/{{OS}}/taskfile.yaml"
  wsl: ".taskfiles/windows/taskfile.yaml"

tasks:
  clean:
    cmd: bash {{.ROOT_DIR}}/scripts/unix/cleanup.sh {{.ROOT_DIR}}
    desc: Clean up system (sync-conflicts, broken symlinks, caches, etc.)
    interactive: true

  configure:
    cmds:
      - task: stow
      - task: configure-links
      - task: os:configure
    desc: Configure OS-specific settings and applications

  default:
    cmd: task -l
    desc: List all available tasks
    silent: true

  install:
    cmds:
      - task: install-casks
      - task: install-formulae
      - task: os:install
      - task: start-services
    desc: Install OS specific packages and Homebrew packages

  install-casks:
    cmd: brew install --force --cask {{range .casks}}{{.}} {{end}}
    desc: Install Homebrew casks
    status:
      - test -z "{{.casks}}"

  install-formulae:
    cmd: brew install --force {{range .formulae}}{{.}} {{end}}
    desc: Install Homebrew formulae
    status:
      - test -z "{{.formulae}}"

  configure-links:
    cmd: brew link --overwrite --force {{range .links}}{{.}} {{end}}
    desc: Override brew links for formulae
    status:
      - test -z "{{.links}}"

  mount:
    cmd: "{{.ROOT_DIR}}/scripts/unix/configure-mounts.sh {{.CLI_ARGS}}"
    desc: "Configure and mount SMB shares. Usage: task mount [mount_name]"
    dir: "{{.ROOT_DIR}}"
    interactive: true

  setup:
    cmds:
      - task: install
      - task: configure
    desc: Install and configure jsh

  start-services:
    cmd: brew services start {{range .services}}{{.}} {{end}}
    desc: Start brew services
    status:
      - test -z "{{.services}}"

  stow:
    cmds:
      - |
        echo "ðŸ” Checking for broken symlinks in home directory..."
        find ~ -maxdepth 1 -type l ! -exec test -e {} \; -print | \
          while read -r link; do
            echo "ðŸ—‘ï¸  Removing broken symlink: $link"
            rm "$link"
          done
      - stow -v dotfiles
      - echo "âœ… Dotfiles deployed successfully"
    desc: Deploy dotfiles to home directory using GNU stow
    dir: "{{.ROOT_DIR}}"
    silent: true

  unstow:
    cmds:
      - |
        echo "ðŸ” Finding and removing all stow-managed symlinks (including orphaned)..."
        find ~ -maxdepth 1 -type l -print | \
          while read -r link; do
            target=$(readlink "$link" 2>/dev/null || echo "")
            if [[ -z "$target" || ! -e "$target" ]]; then
              echo "ðŸ—‘ï¸  Removing symlink: $link (orphaned)"
              rm "$link"
            elif [[ "$target" == *"{{.ROOT_DIR}}"* ]]; then
              echo "ðŸ—‘ï¸  Removing symlink: $link -> $target"
              rm "$link"
            fi
          done
      - echo "âœ… Symlinks removed successfully"
    desc: "Remove stow-managed symlinks (debugging measure, includes orphaned links)"
    dir: "{{.ROOT_DIR}}"
    interactive: true

  uninstall:
    cmds:
      - stow -D .
      - "{{.ROOT_DIR}}/scripts/unix/brew.sh uninstall"
    desc: Retract dotfiles and completely uninstall Homebrew
    dir: "{{.ROOT_DIR}}"
    interactive: true

  update:
    cmds:
      - cmd: brew update
      - cmd: brew upgrade
      - task: os:upgrade
      - cmd: jsh brew check
        ignore_error: true
    desc: Upgrade brew packages and OS-specific packages

version: 3
