---
# yaml-language-server: $schema=https://taskfile.dev/schema.json

dotenv:
  - .env
  - "{{.ENV}}/.env."
  - "{{.HOME}}/.env"

env:
  PATH: /home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:{{.PATH}}

includes:
  os: ".taskfiles/{{OS}}/taskfile.yaml"
  wsl: ".taskfiles/windows/taskfile.yaml"

tasks:
  backup:
    cmds:
      - mkdir -p {{.ROOT_DIR}}/backup/{{.TIMESTAMP}}
      - cmd: |
          echo "Backing up current configs to {{.ROOT_DIR}}/backup/{{.TIMESTAMP}}..."
          # Backup key config files from home directory
          for file in .zshrc .vimrc .tmux.conf .gitconfig .inputrc; do
            if [ -f "$HOME/$file" ] && [ ! -L "$HOME/$file" ]; then
              cp "$HOME/$file" {{.ROOT_DIR}}/backup/{{.TIMESTAMP}}/ 2>/dev/null || true
            fi
          done
          echo "✓ Backup completed at {{.ROOT_DIR}}/backup/{{.TIMESTAMP}}"
    desc: Backup current configs before applying jsh changes
    vars:
      TIMESTAMP:
        sh: date +%Y%m%d_%H%M%S

  chsh:
    cmd: chsh -s /bin/zsh
    status:
      - test "$(basename -- "$SHELL")" == "zsh"

  cleanup:
    cmds:
      - cmd: task cleanup-sync-conflicts
        ignore_error: true
      - cmd: task cleanup-kube-cache
        ignore_error: true
      - cmd: task cleanup-git
        ignore_error: true
    desc: Clean up local paths known for excessive files

  cleanup-git:
    cmd: git gc --aggressive --prune=now
    dir: "{{.ROOT_DIR}}"
    prompt: Delete git objects and untracked files?

  cleanup-kube-cache:
    cmd: rm -rf {{.ROOT_DIR}}/.kube/cache
    dir: "{{.ROOT_DIR}}"
    prompt: Delete kubectl cache files?

  cleanup-sync-conflicts:
    cmd: find {{.ROOT_DIR}} -name "*.sync-conflict*" -delete
    prompt: Delete sync conflict files?

  commit:
    aliases:
      - cz
    cmd: cz commit
    desc: Interactive conventional commit using commitizen
    dir: "{{.ROOT_DIR}}"
    interactive: true
    preconditions:
      - msg: "commitizen not found. Install with: pip install commitizen"
        sh: command -v cz

  configure:
    cmds:
      - task: stow
      - task: chsh
      - task: git
      - task: mount
      - task: os:configure
    desc: Configure OS-specific settings and applications

  default:
    cmd: task -l
    silent: true

  fzf:
    cmd: "{{.ROOT_DIR}}/.fzf/install --bin --no-zsh"
    preconditions:
      - msg: "fzf install script not found. Run: git submodule update --init"
        sh: test -x "{{.ROOT_DIR}}/.fzf/install"

  git:
    cmds:
      - task: git-submodules
      - task: git-hooks

  git-hooks:
    cmd: pre-commit install --hook-type commit-msg
    dir: "{{.ROOT_DIR}}"
    preconditions:
      - msg: "pre-commit not found. Install with: task install"
        sh: command -v pre-commit

  git-submodules:
    cmd: git submodule update --init --remote

  install:
    aliases:
      - init
      - provision
      - setup
    cmds:
      - task: install-deps
      - task: os:install
    desc: Provision installations and configurations

  install-casks:
    cmd: brew install --force --cask {{range .casks}}{{.}} {{end}}
    status:
      - test -z "{{.casks}}"

  install-deps:
    cmds:
      - task: fzf
      - task: install-homebrew
      - task: install-casks
      - task: install-formulae
      - task: install-links

  install-formulae:
    cmd: brew install --force {{range .formulae}}{{.}} {{end}}
    status:
      - test -z "{{.formulae}}"

  install-homebrew:
    cmd: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    status:
      - command -v brew

  install-links:
    cmd: brew install --force {{range .links}}{{.}} {{end}}
    status:
      - test -z "{{.links}}"

  lint:
    cmds:
      - cmd: shellcheck --severity=warning --exclude=SC1071 .bin/* scripts/**/*.sh 2>/dev/null || true
      - cmd: yamllint taskfile.yaml .taskfiles/**/*.yaml 2>/dev/null || echo "⚠ yamllint not found, skipping YAML lint"
        ignore_error: true
      - cmd: markdownlint '**/*.md' --ignore node_modules --ignore .fzf 2>/dev/null || echo "⚠ markdownlint not found, skipping markdown lint"
        ignore_error: true
    desc: Run all linters (shellcheck, yamllint, markdownlint)

  mount:
    cmd: "{{.ROOT_DIR}}/scripts/unix/configure-mounts.sh {{.CLI_ARGS}}"
    desc: "Configure and mount SMB shares. Usage: task mount [mount_name]"
    dir: "{{.ROOT_DIR}}"
    interactive: true

  preflight:
    cmds:
      - cmd: |
          echo "Running pre-flight checks..."
          # Check for required commands
          MISSING_CMDS=()
          for cmd in git stow curl wget; do
            if ! command -v "$cmd" &> /dev/null; then
              MISSING_CMDS+=("$cmd")
            fi
          done
          if [ ${#MISSING_CMDS[@]} -ne 0 ]; then
            echo "✗ Error: Missing required commands: ${MISSING_CMDS[*]}"
            echo "  Please install these before running setup."
            exit 1
          fi
          # Check for internet connectivity
          if ! curl -s --connect-timeout 5 https://google.com > /dev/null 2>&1; then
            echo "⚠ Warning: No internet connection detected. Some installations may fail."
          fi
          echo "✓ Pre-flight checks passed"
    desc: Verify prerequisites before running setup
    silent: false

  setup:
    cmds:
      - task: preflight
      - task: install
      - task: configure
    desc: Configure and install jsh

  stow:
    cmd: stow . --adopt
    dir: "{{.ROOT_DIR}}"

  uninstall:
    cmd: stow -D .
    desc: Retract dotfiles from home directory
    dir: "{{.ROOT_DIR}}"

  update:
    cmds:
      - cmd: zsh -ic "zinit self-update"
        ignore_error: true
      - cmd: zsh -ic "zinit update --all"
        ignore_error: true
      - cmd: brew update
    desc: Update brew and system package lists

  upgrade:
    cmds:
      - cmd: brew upgrade
        ignore_error: true
      - task: os:upgrade
    desc: Upgrade brew packages, system packages, and zsh plugins (zinit/p10k)

version: 3
