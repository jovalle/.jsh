# tmux.conf - Jsh tmux configuration
# No plugins (TPM-free), pure tmux
# Compatible with tmux 2.1+ with graceful degradation

# =============================================================================
# Version Detection Helper
# =============================================================================
# Use if-shell for version conditionals:
#   if-shell '[ "$(tmux -V | cut -c6-)" \> "2.9" ]' 'new_syntax' 'old_syntax'
#   if-shell '[ "$(tmux -V | cut -c6-)" \< "3.0" ]' 'old_only'

# =============================================================================
# General Settings
# =============================================================================

# Modern terminal (256color works everywhere, RGB/Tc for modern terms)
set -g default-terminal "tmux-256color"
# True color support (tmux 2.2+)
if-shell '[ "$(tmux -V | cut -c6-)" \> "2.1" ]' \
    'set -sa terminal-features ",xterm-256color:RGB"; set -ga terminal-overrides ",*256col*:Tc"'

# Undercurl support (tmux 2.4+)
if-shell '[ "$(tmux -V | cut -c6-)" \> "2.3" ]' \
    'set -as terminal-overrides ",*:Smulx=\\E[4::%p1%dm"; set -as terminal-overrides ",*:Setulc=\\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m"'

# Enable mouse (syntax changed in 2.1)
set -g mouse on

# Start windows and panes at 1
set -g base-index 1
setw -g pane-base-index 1
# renumber-windows (tmux 1.7+)
set -g renumber-windows on

# History
set -g history-limit 100000

# Faster escape time (for vim)
set -sg escape-time 10

# Focus events (tmux 1.9+)
set -g focus-events on

# Status refresh
set -g status-interval 5

# Shell override via JSH_TMUX_SHELL environment variable
if-shell '[ -n "$JSH_TMUX_SHELL" ]' 'set -g default-shell "$JSH_TMUX_SHELL"'

# =============================================================================
# Prefix Key
# =============================================================================

# Use both Ctrl-a (like screen) and Ctrl-b (tmux default)
set -g prefix C-a
set -g prefix2 C-b
bind C-a send-prefix
bind C-b send-prefix -2

# Explicitly unbind backtick (not a prefix)
unbind `

# Repeat time for repeated motions (prefix + jj, etc.)
set -g repeat-time 600

# Double tap for last window (prefix + Tab)
bind Tab last-window

# =============================================================================
# Window and Pane Management
# =============================================================================

# --- Native tmux bindings (retained for compatibility) ---
# These are the default tmux bindings - kept for users familiar with standard tmux
# prefix + % : split horizontally (default)
# prefix + " : split vertically (default)
# prefix + arrow : pane navigation (default)
# prefix + n/p : next/previous window (default)
# prefix + 0-9 : select window by number (default)

# --- Enhanced/Preferred Bindings ---
# Split panes (more intuitive symbols)
# | and \ for horizontal (side by side), - for vertical (stacked), _ for horizontal
bind | split-window -h -c "#{pane_current_path}"
bind \\ split-window -h -c "#{pane_current_path}"
# Note: -- ends option parsing so - and _ are treated as key names, not flags
bind -- - split-window -v -c "#{pane_current_path}"
bind -- _ split-window -h -c "#{pane_current_path}"

# New window in current path
bind c new-window -c "#{pane_current_path}"

# Vim-style pane navigation (repeatable: prefix + jj moves two panes)
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R

# Alt+vim keys for pane navigation (no prefix needed)
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Alt+arrow keys for pane navigation (no prefix needed)
bind -n M-Left select-pane -L
bind -n M-Down select-pane -D
bind -n M-Up select-pane -U
bind -n M-Right select-pane -R

# Pane resize (prefix + Shift+vim keys)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# --- Window Navigation ---
# Chrome-style tab navigation with [ and ] (no prefix, Alt modifier)
bind -n M-[ previous-window
bind -n M-] next-window

# Direct window selection (Alt + number, no prefix)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# --- Pane Movement/Swapping ---
# Move pane position within window
bind > swap-pane -D
bind < swap-pane -U

# Maximize pane toggle (zoom)
bind m resize-pane -Z
bind + resize-pane -Z

# Kill pane/window
bind x kill-pane
bind X kill-window

# =============================================================================
# Copy Mode (Vi-style)
# =============================================================================

setw -g mode-keys vi

# Enter copy mode (prefix + Enter or v)
bind Enter copy-mode
bind v copy-mode

# Mouse scroll enters copy mode automatically and scrolls smoothly
bind -n WheelUpPane if-shell -F "#{alternate_on}" "send-keys -M" "select-pane -t=; copy-mode -e; send-keys -M"

# Smooth mouse scrolling (2 lines per tick instead of default 5)
# copy-mode-vi table (tmux 2.4+)
if-shell '[ "$(tmux -V | cut -c6-)" \> "2.3" ]' \
    'bind -T copy-mode-vi WheelUpPane send-keys -X -N 2 scroll-up; bind -T copy-mode-vi WheelDownPane send-keys -X -N 2 scroll-down'

# Vi-style copy bindings (tmux 2.4+ uses -T copy-mode-vi and send-keys -X)
if-shell '[ "$(tmux -V | cut -c6-)" \> "2.3" ]' ' \
    bind -T copy-mode-vi v send-keys -X begin-selection; \
    bind -T copy-mode-vi C-v send-keys -X rectangle-toggle; \
    bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel; \
    bind -T copy-mode-vi Escape send-keys -X cancel; \
    bind -T copy-mode-vi H send-keys -X start-of-line; \
    bind -T copy-mode-vi L send-keys -X end-of-line \
'
# Fallback for tmux 2.1-2.3 (older -t vi-copy syntax)
if-shell '[ "$(tmux -V | cut -c6-)" \< "2.4" ]' ' \
    bind -t vi-copy v begin-selection; \
    bind -t vi-copy y copy-selection; \
    bind -t vi-copy Escape cancel; \
    bind -t vi-copy H start-of-line; \
    bind -t vi-copy L end-of-line \
'

# Copy to system clipboard (tmux 2.4+)
if-shell '[ "$(tmux -V | cut -c6-)" \> "2.3" ] && command -v pbcopy > /dev/null' \
    'bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"; bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"'
if-shell '[ "$(tmux -V | cut -c6-)" \> "2.3" ] && command -v xclip > /dev/null' \
    'bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xclip -selection clipboard"; bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "xclip -selection clipboard"'
if-shell '[ "$(tmux -V | cut -c6-)" \> "2.3" ] && command -v xsel > /dev/null' \
    'bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xsel --clipboard"; bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "xsel --clipboard"'

# Copy to system clipboard (tmux 2.1-2.3 fallback)
if-shell '[ "$(tmux -V | cut -c6-)" \< "2.4" ] && command -v pbcopy > /dev/null' \
    'bind -t vi-copy y copy-pipe "pbcopy"'
if-shell '[ "$(tmux -V | cut -c6-)" \< "2.4" ] && command -v xclip > /dev/null' \
    'bind -t vi-copy y copy-pipe "xclip -selection clipboard"'
if-shell '[ "$(tmux -V | cut -c6-)" \< "2.4" ] && command -v xsel > /dev/null' \
    'bind -t vi-copy y copy-pipe "xsel --clipboard"'

# =============================================================================
# Utilities
# =============================================================================

# Reload config
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Edit config
bind e new-window -n "tmux.conf" 'sh -c "${EDITOR:-vim} ~/.tmux.conf"'

# Sync panes toggle
bind * setw synchronize-panes

# Quick shell commands
bind g new-window -n "lazygit" "lazygit"
bind G new-window -n "lazygit" "lazygit"
bind t new-window -n "htop" "htop || top"

# Session management
bind S choose-session
bind N command-prompt -p "New session:" "new-session -s '%%'"

# =============================================================================
# Status Bar
# =============================================================================

set -g status on
set -g status-position bottom
set -g status-justify left

# Status bar styling (tmux 2.9+ uses -style, older uses -fg/-bg/-attr)
if-shell '[ "$(tmux -V | cut -c6-)" \> "2.8" ]' \
    'set -g status-style "fg=#cdd6f4,bg=#181825"' \
    'set -g status-fg "#cdd6f4"; set -g status-bg "#181825"'

# Left: session name
set -g status-left-length 30
set -g status-left '#[fg=#11111b,bg=#89b4fa,bold] #S #[fg=#89b4fa,bg=#181825,nobold]'

# Right: date time
set -g status-right-length 60
set -g status-right '#[fg=#313244]#[fg=#cdd6f4,bg=#313244] %H:%M #[fg=#89b4fa]#[fg=#11111b,bg=#89b4fa,bold] %d %b '

# Window tabs
set -g window-status-separator ''
set -g window-status-format '#[fg=#6c7086,bg=#181825] #I #W '
set -g window-status-current-format '#[fg=#181825,bg=#313244]#[fg=#cdd6f4,bg=#313244,bold] #I #W #[fg=#313244,bg=#181825]'

# Activity (visual change, no message)
setw -g monitor-activity on
set -g visual-activity off
# activity-action requires tmux 2.6+
if-shell '[ "$(tmux -V | cut -c6-)" \> "2.5" ]' 'set -g activity-action none'

# Activity style (tmux 2.9+ syntax)
if-shell '[ "$(tmux -V | cut -c6-)" \> "2.8" ]' \
    'set -g window-status-activity-style "fg=#f9e2af,bg=#181825,bold"'

# =============================================================================
# Pane Borders
# =============================================================================

# Pane border styling (tmux 2.9+ uses -style, older uses separate options)
if-shell '[ "$(tmux -V | cut -c6-)" \> "2.8" ]' \
    'set -g pane-border-style "fg=#313244"; set -g pane-active-border-style "fg=#89b4fa"' \
    'set -g pane-border-fg "#313244"; set -g pane-active-border-fg "#89b4fa"'

# =============================================================================
# Message Style
# =============================================================================

# Message styling (tmux 2.9+ uses -style, older uses -fg/-bg)
if-shell '[ "$(tmux -V | cut -c6-)" \> "2.8" ]' \
    'set -g message-style "fg=#cdd6f4,bg=#313244"; set -g message-command-style "fg=#cdd6f4,bg=#313244"' \
    'set -g message-fg "#cdd6f4"; set -g message-bg "#313244"'

# =============================================================================
# Display Panes
# =============================================================================

set -g display-panes-active-colour '#89b4fa'
set -g display-panes-colour '#313244'

# =============================================================================
# Clock Mode
# =============================================================================

setw -g clock-mode-colour '#89b4fa'

# =============================================================================
# Local Overrides
# =============================================================================

if-shell "[ -f ~/.tmux.conf.local ]" "source-file ~/.tmux.conf.local"
