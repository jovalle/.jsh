# ==============================================================================
# tmux Configuration
# ==============================================================================
# Merged from top GitHub dotfiles projects:
# - gpakosz/.tmux (24k+ stars)
# - thoughtbot/dotfiles
# - omerxx/dotfiles
# - dreamsofcode-io/tmux
# - tmux-sensible defaults
#
# Color Palette (Tomorrow Night):
#   #1d1f21 Background     #282a2e Current Line   #373b41 Selection
#   #c6c8c6 Foreground     #969896 Comment        #cc6666 Red
#   #de935f Orange         #fdbe02 Mango (accent) #f0c674 Yellow
#   #b5bd68 Green          #8abeb7 Aqua           #81a2be Blue
#   #b294bb Purple
# ==============================================================================

# ==============================================================================
# CORE SETTINGS
# ==============================================================================

# Modern terminal with true color (24-bit) support
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"
set -ga terminal-overrides ",*256col*:Tc"
set -ga terminal-overrides ",alacritty:Tc"
set -ga terminal-overrides ",ghostty:Tc"

# Undercurl support (for modern terminals like Ghostty, Kitty)
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Extended keys support (for Shift+Enter, Ctrl+Shift combos, etc.)
set -s extended-keys on
set -as terminal-features ',ghostty:extkeys'
set -as terminal-features ',xterm-256color:extkeys'

# Prefix key: Ctrl-A (GNU Screen style)
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# Indexing starts at 1 (matches keyboard layout)
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Performance & responsiveness
set -sg escape-time 0              # No delay for escape key (vim users rejoice)
set -g repeat-time 300             # Repeat time for repeatable commands
set -g focus-events on             # Enable focus events (for vim/neovim)
set -g set-clipboard on            # Enable OSC 52 clipboard

# History & display
set -g history-limit 100000        # Generous scrollback buffer
set -g display-time 2000           # Message display time (ms)
set -g display-panes-time 2000     # Pane indicator display time

# Window behavior
set -g automatic-rename on         # Rename window to current program
set -g automatic-rename-format '#{b:pane_current_path}'
set -g set-titles on               # Set terminal title
set -g set-titles-string '#h - #S:#I #W'
setw -g aggressive-resize on       # Resize to smallest client viewing

# Activity monitoring
set -g monitor-activity on
set -g visual-activity off         # Don't show message, just highlight

# Default shell
set -g default-shell "$SHELL"

# ==============================================================================
# MOUSE & VI MODE
# ==============================================================================

set -g mouse on
set -g mode-keys vi
set -g status-keys vi

# Sync tmux buffer to system clipboard (makes context menu Copy work)
# This pipes all tmux copy operations through pbcopy
set -g copy-command "pbcopy"

# ==============================================================================
# KEY BINDINGS - GENERAL
# ==============================================================================

# Reload configuration
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# Edit configuration
bind e new-window -n 'tmux.conf' "sh -c '\${EDITOR:-vim} ~/.tmux.conf && tmux source ~/.tmux.conf && tmux display \"Config sourced\"'"

# Quick prefix toggle (last window)
bind C-a last-window
bind Tab last-window

# Session management
bind C-c new-session
bind C-f command-prompt -p find-session 'switch-client -t %%'
bind S choose-tree -Zs                    # Session switcher

# Clear screen and scrollback
bind C-l send-keys C-l \; run 'sleep 0.2' \; clear-history

# Toggle synchronized panes
bind * setw synchronize-panes \; display-message "Sync #{?synchronize-panes,ON,OFF}"

# Kill shortcuts
bind x kill-pane
bind X kill-window
bind C-X confirm-before -p "Kill session #S? (y/n)" kill-session

# Respawn pane
bind R respawn-pane -k

# ==============================================================================
# KEY BINDINGS - WINDOWS & PANES
# ==============================================================================

# Split panes (preserve working directory)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind _ split-window -h -c "#{pane_current_path}"

# New window (preserve working directory)
bind c new-window -c "#{pane_current_path}"
bind C new-window  # New window in home directory

# Vim-style pane navigation (with Alt for no-prefix)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Pane resizing (repeatable)
bind -r H resize-pane -L 3
bind -r J resize-pane -D 3
bind -r K resize-pane -U 3
bind -r L resize-pane -R 3
bind -n C-M-h resize-pane -L 3
bind -n C-M-j resize-pane -D 3
bind -n C-M-k resize-pane -U 3
bind -n C-M-l resize-pane -R 3

# Window navigation
bind -r [ previous-window
bind -r ] next-window
bind -n M-[ previous-window
bind -n M-] next-window
bind -r C-h previous-window
bind -r C-l next-window

# Window swapping
bind -r < swap-window -d -t -1
bind -r > swap-window -d -t +1

# Pane swapping
bind -r '{' swap-pane -U
bind -r '}' swap-pane -D

# Maximize pane (toggle)
bind m resize-pane -Z
bind + resize-pane -Z

# Cycle layouts
bind Space next-layout

# ==============================================================================
# KEY BINDINGS - COPY MODE (Vi Style)
# ==============================================================================

bind Enter copy-mode
bind -n C-f copy-mode \; send-key ?    # Quick search mode

# Vi-style copy mode bindings
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line

# Double/triple click selection
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send -X select-word
bind -T copy-mode-vi TripleClick1Pane select-pane \; send -X select-line

# Buffer management
bind b list-buffers
bind p paste-buffer -p
bind P choose-buffer

# Capture pane content to file
bind C-c run 'FILE=/tmp/tmux-capture-$(date +%Y%m%d%H%M%S).txt; tmux capture-pane -J -S -10000 -p > $FILE; tmux display "Captured to $FILE"'

# ==============================================================================
# CLIPBOARD INTEGRATION (Multi-platform)
# ==============================================================================

# macOS
if-shell 'command -v pbcopy > /dev/null 2>&1' {
  bind y run -b 'tmux save-buffer - | pbcopy'
  bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'pbcopy'
  bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'pbcopy'
}

# Linux with xsel
if-shell '! command -v pbcopy > /dev/null 2>&1 && command -v xsel > /dev/null 2>&1' {
  bind y run -b 'tmux save-buffer - | xsel -i -b'
  bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'xsel -i -b'
  bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'xsel -i -b'
}

# Linux with xclip
if-shell '! command -v pbcopy > /dev/null 2>&1 && ! command -v xsel > /dev/null 2>&1 && command -v xclip > /dev/null 2>&1' {
  bind y run -b 'tmux save-buffer - | xclip -i -selection clipboard'
  bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'xclip -i -selection clipboard'
  bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'xclip -i -selection clipboard'
}

# Wayland with wl-copy
if-shell 'command -v wl-copy > /dev/null 2>&1' {
  bind y run -b 'tmux save-buffer - | wl-copy'
  bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'wl-copy'
  bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'wl-copy'
}

# WSL
if-shell 'command -v clip.exe > /dev/null 2>&1' {
  bind y run -b 'tmux save-buffer - | clip.exe'
  bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'clip.exe'
}

# ==============================================================================
# APPEARANCE - STATUS BAR
# ==============================================================================

set -g status on
set -g status-interval 5
set -g status-position bottom
set -g status-justify left
set -g status-style "bg=default,fg=#c6c8c6"

# Left side: session info
set -g status-left-length 40
set -g status-left "#[fg=#1d1f21,bg=#ffa827,bold] #S #[fg=#ffa827,bg=default] "

# Right side: host, date/time
set -g status-right-length 80
set -g status-right "#[fg=#666666]#(whoami)@#h #[fg=#969896]| #[fg=#c6c8c6,bg=#282a2e] %b %d #[fg=#ffa827,bold]%H:%M "

# Window status (inactive)
set -g window-status-format "#[fg=#666666,bg=default] #I #[fg=#969896]#W "

# Window status (active)
set -g window-status-current-format "#[fg=#1d1f21,bg=#373b41] #I #[fg=#ffa827,bold]#W#[fg=#81a2be]#{?window_zoomed_flag, Z,} "

# Window status separator
set -g window-status-separator ""

# Activity style
set -g window-status-activity-style "fg=#f0c674,bg=default"

# ==============================================================================
# APPEARANCE - PANES & MESSAGES
# ==============================================================================

# Pane borders
set -g pane-border-style "fg=#373b41"
set -g pane-active-border-style "fg=#ffa827"

# Pane indicator numbers
set -g display-panes-colour "#666666"
set -g display-panes-active-colour "#ffa827"

# Message styling
set -g message-style "fg=#ffa827,bg=#282a2e,bold"
set -g message-command-style "fg=#ffa827,bg=#282a2e"

# Mode styling (copy mode, etc.)
set -g mode-style "fg=#1d1f21,bg=#ffa827"

# Clock
set -g clock-mode-colour "#ffa827"
set -g clock-mode-style 24

# ==============================================================================
# POPUP & FLOATING WINDOWS (tmux 3.2+)
# ==============================================================================

# Floating terminal (Ctrl-A + g)
bind g display-popup -E -w 80% -h 80% -d "#{pane_current_path}"

# Floating lazygit
bind G display-popup -E -w 90% -h 90% -d "#{pane_current_path}" "lazygit"

# Floating htop/btop
bind t display-popup -E -w 90% -h 90% "htop || top"

# Floating file manager
bind f display-popup -E -w 90% -h 90% -d "#{pane_current_path}" "yazi || ranger || mc || ls -la"

# Quick notes
bind n display-popup -E -w 60% -h 60% "$EDITOR ~/notes.md"

# ==============================================================================
# HOOKS
# ==============================================================================

# Alert when process completes in other window
set-hook -g alert-activity 'run-shell "tmux display-message \"Activity in #W\""'

# Renumber windows on close (redundant with renumber-windows but ensures it)
set-hook -g window-unlinked 'run-shell "tmux move-window -r"'

# ==============================================================================
# TPM - TMUX PLUGIN MANAGER
# ==============================================================================
# Install: git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# Press prefix + I to install plugins
# Press prefix + U to update plugins

# Plugin list
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'christoomey/vim-tmux-navigator'

# tmux-resurrect: Save/restore sessions
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-processes 'ssh "~vim" "~nvim" "~hx"'

# tmux-continuum: Auto-save sessions
set -g @continuum-restore 'on'
set -g @continuum-save-interval '10'

# tmux-yank: System clipboard integration
set -g @yank_selection 'clipboard'
set -g @yank_selection_mouse 'clipboard'
set -g @yank_action 'copy-pipe-and-cancel'

# vim-tmux-navigator: Seamless navigation between vim/tmux
# Use Ctrl + hjkl to navigate between vim and tmux panes
# Note: Requires vim plugin: christoomey/vim-tmux-navigator

# ==============================================================================
# LOCAL OVERRIDES
# ==============================================================================
# Create ~/.tmux.conf.local for machine-specific settings

if-shell '[ -f ~/.tmux.conf.local ]' 'source-file ~/.tmux.conf.local'

# ==============================================================================
# INITIALIZE TPM (Keep at the bottom)
# ==============================================================================

run '~/.tmux/plugins/tpm/tpm'
