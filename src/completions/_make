#compdef make gmake

# Completion function for make - show only Makefile targets
# This replaces the default make completion to show only actual targets,
# not files or variables

_make() {
  local -a targets
  local expl

  # Check if a Makefile exists in current directory
  if [[ -f Makefile ]] || [[ -f makefile ]] || [[ -f GNUmakefile ]]; then
    # Extract targets from Makefile using make's -qp flag
    # Filter to only show actual targets (not special targets, files, or variables)
    targets=($(make -qp 2>/dev/null | \
               grep -E '^[a-zA-Z0-9_-]+:' | \
               cut -d: -f1 | \
               grep -vE '^\.|^Makefile$|^makefile$|^GNUmakefile$' | \
               sort -u))

    if (( ${#targets[@]} > 0 )); then
      # Use _wanted to properly tag completions and prevent fallback to files
      _wanted targets expl 'make target' compadd -a targets
      return 0
    fi
  fi

  # No Makefile found
  _message 'no Makefile found'
  return 1
}

_make "$@"
