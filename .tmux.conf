# tmux.conf - Jsh tmux configuration
# No plugins (TPM-free), pure tmux

# =============================================================================
# General Settings
# =============================================================================

# Modern terminal
set -g default-terminal "tmux-256color"
set -sa terminal-features ',xterm-256color:RGB'
set -ga terminal-overrides ',*256col*:Tc'

# Undercurl support
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Enable mouse
set -g mouse on

# Start windows and panes at 1
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# History
set -g history-limit 100000

# Faster escape time (for vim)
set -sg escape-time 10

# Focus events
set -g focus-events on

# Status refresh
set -g status-interval 5

# =============================================================================
# Prefix Key
# =============================================================================

# Use both Ctrl-a (like screen) and Ctrl-b (tmux default)
set -g prefix C-a
set -g prefix2 C-b
bind C-a send-prefix
bind C-b send-prefix -2

# Explicitly unbind backtick (not a prefix)
unbind `

# Repeat time for repeated motions (prefix + jj, etc.)
set -g repeat-time 600

# Double tap for last window
bind Tab last-window

# =============================================================================
# Window and Pane Management
# =============================================================================

# Split panes (more intuitive)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind \\ split-window -h -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# New window in current path
bind c new-window -c "#{pane_current_path}"

# Vim-style pane navigation (repeatable: prefix + jj moves two panes)
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R

# Alt+vim keys (no prefix)
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Pane resize
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Window navigation
bind -n M-[ previous-window
bind -n M-] next-window
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Maximize pane toggle
bind m resize-pane -Z
bind + resize-pane -Z

# Swap panes
bind > swap-pane -D
bind < swap-pane -U

# Kill pane/window
bind x kill-pane
bind X kill-window

# =============================================================================
# Copy Mode (Vi-style)
# =============================================================================

setw -g mode-keys vi

# Enter copy mode
bind Enter copy-mode
bind v copy-mode

# Mouse scroll enters copy mode automatically and scrolls smoothly
bind -n WheelUpPane if-shell -F "#{alternate_on}" "send-keys -M" "select-pane -t=; copy-mode -e; send-keys -M"

# Smooth mouse scrolling (2 lines per tick instead of default 5)
bind -T copy-mode-vi WheelUpPane send-keys -X -N 2 scroll-up
bind -T copy-mode-vi WheelDownPane send-keys -X -N 2 scroll-down

# Vi-style copy
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send-keys -X cancel
bind -T copy-mode-vi H send-keys -X start-of-line
bind -T copy-mode-vi L send-keys -X end-of-line

# Copy to system clipboard
if-shell "command -v pbcopy" {
    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
    bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"
}
if-shell "command -v xclip" {
    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xclip -selection clipboard"
    bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "xclip -selection clipboard"
}
if-shell "command -v xsel" {
    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xsel --clipboard"
    bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "xsel --clipboard"
}

# =============================================================================
# Utilities
# =============================================================================

# Reload config
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Edit config
bind e new-window -n "tmux.conf" 'sh -c "${EDITOR:-vim} ~/.tmux.conf"'

# Sync panes toggle
bind * setw synchronize-panes

# Quick shell commands
bind g new-window -n "lazygit" "lazygit"
bind G new-window -n "lazygit" "lazygit"
bind t new-window -n "htop" "htop || top"

# Session management
bind S choose-session
bind N command-prompt -p "New session:" "new-session -s '%%'"

# =============================================================================
# Status Bar
# =============================================================================

set -g status on
set -g status-position bottom
set -g status-justify left
set -g status-style 'fg=#cdd6f4,bg=#181825'

# Left: session name
set -g status-left-length 30
set -g status-left '#[fg=#11111b,bg=#89b4fa,bold] #S #[fg=#89b4fa,bg=#181825,nobold]'

# Right: date time
set -g status-right-length 60
set -g status-right '#[fg=#313244]#[fg=#cdd6f4,bg=#313244] %H:%M #[fg=#89b4fa]#[fg=#11111b,bg=#89b4fa,bold] %d %b '

# Window tabs
set -g window-status-separator ''
set -g window-status-format '#[fg=#6c7086,bg=#181825] #I #W '
set -g window-status-current-format '#[fg=#181825,bg=#313244]#[fg=#cdd6f4,bg=#313244,bold] #I #W #[fg=#313244,bg=#181825]'

# Activity (visual change, no message)
setw -g monitor-activity on
set -g visual-activity off
set -g activity-action none
set -g window-status-activity-style 'fg=#f9e2af,bg=#181825,bold'

# =============================================================================
# Pane Borders
# =============================================================================

set -g pane-border-style 'fg=#313244'
set -g pane-active-border-style 'fg=#89b4fa'

# =============================================================================
# Message Style
# =============================================================================

set -g message-style 'fg=#cdd6f4,bg=#313244'
set -g message-command-style 'fg=#cdd6f4,bg=#313244'

# =============================================================================
# Display Panes
# =============================================================================

set -g display-panes-active-colour '#89b4fa'
set -g display-panes-colour '#313244'

# =============================================================================
# Clock Mode
# =============================================================================

setw -g clock-mode-colour '#89b4fa'

# =============================================================================
# Local Overrides
# =============================================================================

if-shell "[ -f ~/.tmux.conf.local ]" "source-file ~/.tmux.conf.local"
